# Copyright 2011-2012 Chernov A.A.
# Distributed under the terms of the GNU General Public License v2

DESCRIPTION="Larry Wall's Practical Extraction and Report Language"

HOMEPAGE="http://www.perl.org/"

LICENSE="|| ( Artistic GPL-1 GPL-2 GPL-3 )"

#   dependencies:
# dev-util/dmake
# app-arch/libbz2
# sys-libs/zlib

SRC_URI="http://www.cpan.org/src/${P}.tar.bz2"

src_unpack()
{
	unpack $A
	cd ${P}/win32 || die "Can't cd to win32"
}

src_prepare()
{
	if [ -d "${PREFIX}/perl" ]
	then
		eerror "Please delete ${PREFIX}/perl first before continuing!"
	fi
}

src_configure()
{
	# edit makefile.mk
	prefix_w=`posix_w32path "${PREFIX}"`
	prefix_w=`echo ${prefix_w} | sed -e 's/\\//\\\/g'`
	local prefix_ws=`echo ${prefix_w} | sed -e 's/\\\/\\\\\\\/g'`

	local inst_drv=`echo ${prefix_w} | sed -e 's/^\(.*\:\).*/\1/'`
	local inst_top=`echo ${prefix_w} | sed -e "s/^${inst_drv}/\\$(INST_DRV)/"`
	inst_top="${inst_top}\\perl"
	inst_top=`echo ${inst_top} | sed -e 's/\\\/\\\\\\\/g'`
	
	# set INST_DRV
	cat makefile.mk | sed -e "s/^INST_DRV\\t\\*\\=.*$/INST_DRV\\t\\*\\=\\ ${inst_drv}/" > makefile.mk.new
	mv -f makefile.mk.new makefile.mk
	
	# set INST_TOP
	cat makefile.mk | sed -e "s/^INST_TOP\\t\\*\\=.*$/INST_TOP\\t\\*\\=\\ ${inst_top}/" > makefile.mk.new
	mv -f makefile.mk.new makefile.mk
	
	# build a 32-bit Perl using a 32-bit compiler on a 64-bit version of Windows
	#cat makefile.mk | sed -e 's/^#WIN64\t*\*\=\ undef$/WIN64\t\*\=\ undef/' > makefile.mk.new
	#mv -f makefile.mk.new makefile.mk
	
	# build a 64-bit Perl
	cat makefile.mk | sed -e 's/^#WIN64\t*\*\=\ undef$/WIN64\t\*\=\ define/' > makefile.mk.new
	mv -f makefile.mk.new makefile.mk

	# define mingw-w64 crosscompiler
	#cat makefile.mk | sed -e 's/^#GCCCROSS\t*\*\=\ define$/GCCCROSS\t\*\=\ define/' > makefile.mk.new
	#mv -f makefile.mk.new makefile.mk

	# set proper path to mingw
	cat makefile.mk | sed -e "s/C\\:\\\\MinGW/${prefix_ws}/" > makefile.mk.new
	mv -f makefile.mk.new makefile.mk

	# make build script for Windows Console
	echo "set PATH=%SystemRoot%\system32;%SystemRoot%;${prefix_w}\bin" > build.cmd
	echo "dmake %1 %2 %3 %4 %5 %6 %7 %8 %9" >> build.cmd
	#echo "pause" >> build.cmd
	echo "exit" >> build.cmd
}

src_compile()
{
	#start //I //WAIT build.cmd
	echo ""
}

src_install()
{
	start //I //WAIT build.cmd install
	# this is bad code, but i can't how to make it better :(
	install -d ${INSTDIR}${PREFIX}
	mv -fv "${PREFIX}/perl/" ${INSTDIR}${PREFIX}
}
