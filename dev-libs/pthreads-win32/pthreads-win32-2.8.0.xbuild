# Copyright 2010-2014 Chernov A.A.
# Distributed under the terms of the GNU General Public License v3

DESCRIPTION="Open Source POSIX Threads for Win32"

HOMEPAGE="http://www.sourceware.org/pthreads-win32/"

LICENSE="LGPL"

DEPEND="!dev-libs/winpthreads"

SRC_URI="ftp://sourceware.org/pub/${PN}/pthreads-w32-2-8-0-release.tar.gz"

SOURCES_DIR="pthreads-w32-2-8-0-release"

src_configure()
{
	:
}

src_compile()
{
	make clean GC
	checkexitcode $? "make failed"
	mv libpthreadGC2.a  libpthread.dll.a

	make clean GC-static
	test $? || eerror "make failed"
	mv libpthreadGC2.a libpthread.a
	
	cat > libpthread.la << EOF
# libpthread.la - a libtool library file
# Generated by ltmain.sh - GNU libtool 1.5.24 (1.1220.2.456 2007/06/24 02:25:32)
#
# Please DO NOT delete this file!
# It is necessary for linking the library.

# The name that we can dlopen(3).
dlname='../bin/pthreadGC2.dll'

# Names of this library.
library_names='libpthread.dll.a'

# The name of the static archive.
old_library='libpthread.a'

# Libraries that this one depends upon.
dependency_libs=''

# Version information for libpthread.
current=2
age=8
revision=0

# Is this an already installed library?
installed=yes

# Should we warn about portability when linking against -modules?
shouldnotlink=no

# Files to dlopen/dlpreopen
dlopen=''
dlpreopen=''

# Directory that this library needs to be installed in:
libdir='/mingw/lib'
EOF
}

src_install()
{
	install -d "${INSTDIR}${PREFIX}/bin" "${INSTDIR}${PREFIX}/lib" "${INSTDIR}${PREFIX}/include"
	install -t "${INSTDIR}${PREFIX}/bin" pthread*.dll
	install -t "${INSTDIR}${PREFIX}/lib" libpthread*.a
	install -t "${INSTDIR}${PREFIX}/lib" libpthread.la
	install -t "${INSTDIR}${PREFIX}/include" pthread.h sched.h semaphore.h
}
